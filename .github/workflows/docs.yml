# Documentation generation and validation workflow
name: Documentation

on:
  push:
    branches: [ master ]
    paths:
      - 'internal/provider/**'
      - 'examples/**'
      - 'docs/**'
      - 'tools/**'
  pull_request:
    paths:
      - 'internal/provider/**'
      - 'examples/**'
      - 'docs/**'
      - 'tools/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  GO_VERSION: '1.21'

jobs:
  # Generate and validate documentation
  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Install tfplugindocs
        run: go install github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@latest

      - name: Generate documentation
        run: make generate

      - name: Validate generated docs
        run: |
          # Check if docs directory exists and has content
          if [ ! -d "docs" ] || [ -z "$(ls -A docs)" ]; then
            echo "Documentation generation failed - no docs directory or empty"
            exit 1
          fi
          
          # Check for required documentation files
          required_files=("docs/index.md" "docs/resources" "docs/data-sources")
          for file in "${required_files[@]}"; do
            if [ ! -e "$file" ]; then
              echo "Required documentation file/directory missing: $file"
              exit 1
            fi
          done

      - name: Check for documentation changes
        id: docs_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit documentation changes
        if: steps.docs_changes.outputs.changes == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          git commit -m "docs: auto-generate provider documentation" || exit 0
          git push

      - name: Create PR for documentation updates
        if: steps.docs_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: auto-generate provider documentation"
          title: "docs: auto-generate provider documentation"
          body: |
            This PR contains automatically generated documentation updates.
            
            Generated by the documentation workflow after detecting changes in:
            - Provider schema
            - Resource definitions
            - Data source definitions
            - Examples
          branch: docs/auto-generate-${{ github.run_number }}
          delete-branch: true

  # Validate examples
  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        example: [basic-usage, multi-environment, tls-example]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Validate example: ${{ matrix.example }}
        run: |
          cd examples/${{ matrix.example }}
          
          # Initialize without backend
          terraform init -backend=false
          
          # Validate syntax
          terraform validate
          
          # Format check
          terraform fmt -check=true -diff=true
          
          # Basic plan (may fail without real Redis, but should not have syntax errors)
          terraform plan -out=plan.tfplan || echo "Plan failed as expected without real Redis connection"

      - name: Check example documentation
        run: |
          cd examples/${{ matrix.example }}
          if [ ! -f "README.md" ]; then
            echo "README.md missing in example: ${{ matrix.example }}"
            exit 1
          fi
          
          # Check if README contains basic sections
          required_sections=("Usage" "Prerequisites")
          for section in "${required_sections[@]}"; do
            if ! grep -q "$section" README.md; then
              echo "Required section '$section' missing in ${{ matrix.example }}/README.md"
              exit 1
            fi
          done

  # Link checking
  check-links:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check links in documentation
        uses: lycheeverse/lychee-action@v1
        with:
          args: |
            --verbose
            --no-progress
            --exclude-mail
            --exclude="localhost"
            --exclude="127.0.0.1"
            --exclude="redis.example.com"
            --exclude="your-domain.com"
            README.md
            CONTRIBUTING.md
            examples/**/*.md
            docs/**/*.md
        fail: true

  # Spell checking
  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Spell check documentation
        uses: crate-ci/typos@master
        with:
          files: |
            README.md
            CONTRIBUTING.md
            CHANGELOG.md
            examples/**/*.md
            docs/**/*.md

  # Documentation success check
  docs-success:
    name: Documentation Success
    runs-on: ubuntu-latest
    needs: [generate-docs, validate-examples, check-links, spell-check]
    if: always()
    steps:
      - name: Check documentation workflow results
        run: |
          if [[ "${{ needs.generate-docs.result }}" != "success" || \
                "${{ needs.validate-examples.result }}" != "success" || \
                "${{ needs.check-links.result }}" != "success" || \
                "${{ needs.spell-check.result }}" != "success" ]]; then
            echo "One or more documentation jobs failed"
            exit 1
          fi
          echo "All documentation checks passed! ðŸ“š"