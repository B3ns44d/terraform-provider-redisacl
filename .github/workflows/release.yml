name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

env:
  GO_VERSION: '1.24'

jobs:
  # Pre-release validation
  pre-release-validation:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Check if this is a pre-release (contains alpha, beta, rc)
          if [[ "${VERSION}" =~ (alpha|beta|rc) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "${VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "Invalid version format: ${VERSION}"
            echo "Expected format: v1.2.3 or v1.2.3-alpha1"
            exit 1
          fi

      - name: Run full test suite
        env:
          TF_ACC: "1"
        run: |
          make test
          make testacc

      - name: Check changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! grep -q "${VERSION#v}" CHANGELOG.md; then
            echo "Version ${VERSION#v} not found in CHANGELOG.md"
            echo "Please update CHANGELOG.md before releasing"
            exit 1
          fi

  # Build and release
  goreleaser:
    name: GoReleaser Build and Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: pre-release-validation
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          trust_level: 5

      - name: Debug GPG setup
        run: |
          echo "=== GPG Debug Information ==="
          echo "GPG version:"
          gpg --version | head -1
          echo ""
          echo "GPG fingerprint from import: ${{ steps.import_gpg.outputs.fingerprint }}"
          echo "GPG key ID from import: ${{ steps.import_gpg.outputs.keyid }}"
          echo "GPG name from import: ${{ steps.import_gpg.outputs.name }}"
          echo "GPG email from import: ${{ steps.import_gpg.outputs.email }}"
          echo ""
          echo "=== Available Secret Keys ==="
          gpg --list-secret-keys --keyid-format LONG
          echo ""
          echo "=== Available Public Keys ==="
          gpg --list-keys --keyid-format LONG
          echo ""
          echo "=== GPG Configuration ==="
          gpg --list-config
          echo ""
          echo "=== Test GPG Signing ==="
          echo "test signing" > test.txt
          if gpg --batch --yes --pinentry-mode loopback --passphrase "${{ secrets.PASSPHRASE }}" --detach-sign --armor --local-user "${{ steps.import_gpg.outputs.fingerprint }}" test.txt; then
            echo "GPG signing test PASSED"
            ls -la test.txt*
            cat test.txt.asc
          else
            echo "GPG signing test FAILED"
            echo "Trying with key ID instead of fingerprint..."
            if gpg --batch --yes --pinentry-mode loopback --passphrase "${{ secrets.PASSPHRASE }}" --detach-sign --armor --local-user "${{ steps.import_gpg.outputs.keyid }}" test.txt; then
              echo "GPG signing with key ID PASSED"
            else
              echo "GPG signing with key ID also FAILED"
            fi
          fi
          rm -f test.txt test.txt.asc

      - name: Run GoReleaser (Dry Run)
        if: github.event_name == 'workflow_dispatch'
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --skip-publish --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          GPG_PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Run GoReleaser (Release)
        if: github.event_name == 'push'
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          GPG_PASSPHRASE: ${{ secrets.PASSPHRASE }}

  # Terraform Registry publication
  terraform-registry:
    name: Terraform Registry Publication
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-release-validation, goreleaser]
    if: github.event_name == 'push' && needs.pre-release-validation.outputs.is_prerelease == 'false'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify GoReleaser configuration
        run: |
          if [ ! -f ".goreleaser.yml" ]; then
            echo ".goreleaser.yml not found"
            echo "This file is required for Terraform Registry publication"
            exit 1
          fi
          
          # Check if GoReleaser config has required fields for Terraform Registry
          if ! grep -q "archives:" .goreleaser.yml; then
            echo "GoReleaser config missing archives section"
            exit 1
          fi

      - name: Wait for release to be available
        run: |
          VERSION="${{ needs.pre-release-validation.outputs.version }}"
          echo "Waiting for release ${VERSION} to be available on GitHub..."
          
          # Wait up to 5 minutes for the release to be available
          for i in {1..30}; do
            if curl -s -f "https://api.github.com/repos/${{ github.repository }}/releases/tags/${VERSION}" > /dev/null; then
              echo "Release ${VERSION} is available!"
              break
            fi
            echo "Attempt $i: Release not yet available, waiting 10 seconds..."
            sleep 10
          done

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Verify release assets
        run: |
          VERSION="${{ needs.pre-release-validation.outputs.version }}"
          
          # Check that required assets exist for Terraform Registry
          RELEASE_DATA=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/${VERSION}")
          
          # Check for checksums file (pattern: PROJECT_VERSION_SHA256SUMS)
          EXPECTED_CHECKSUM="terraform-provider-redisacl_${VERSION#v}_SHA256SUMS"
          if ! echo "$RELEASE_DATA" | jq -r '.assets[].name' | grep -q "$EXPECTED_CHECKSUM"; then
            echo "Missing $EXPECTED_CHECKSUM file in release assets"
            echo "Available assets:"
            echo "$RELEASE_DATA" | jq -r '.assets[].name'
            exit 1
          fi
          
          # Check for signature file
          if ! echo "$RELEASE_DATA" | jq -r '.assets[].name' | grep -q "${EXPECTED_CHECKSUM}.sig"; then
            echo "Missing ${EXPECTED_CHECKSUM}.sig file in release assets"
            exit 1
          fi
          
          echo "All required release assets are present for Terraform Registry"

      - name: Create release announcement
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ needs.pre-release-validation.outputs.version }}';
            const versionNoV = version.replace('v', '');
            
            // Update the release description with Terraform Registry information
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: version
            });
            
            const installationSection = '\n\n## ðŸ“¦ Installation\n\n' +
              'This provider is available on the [Terraform Registry](https://registry.terraform.io/providers/B3ns44d/redisacl/' + versionNoV + ').\n\n' +
              '```hcl\n' +
              'terraform {\n' +
              '  required_providers {\n' +
              '    redisacl = {\n' +
              '      source  = "B3ns44d/redisacl"\n' +
              '      version = "~> ' + versionNoV + '"\n' +
              '    }\n' +
              '  }\n' +
              '}\n' +
              '```\n\n' +
              '## ðŸ“š Documentation\n\n' +
              '- [Provider Documentation](https://registry.terraform.io/providers/B3ns44d/redisacl/' + versionNoV + '/docs)\n' +
              '- [GitHub Repository](https://github.com/${{ github.repository }})\n\n' +
              '---\n\n' +
              '**Note:** The Terraform Registry will automatically detect this release and make it available within a few minutes.';

            const updatedBody = (release.body || '') + installationSection;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: updatedBody
            });



  # Failure notification
  release-failure:
    name: Release Failure Notification
    runs-on: ubuntu-latest
    needs: [pre-release-validation, goreleaser, terraform-registry]
    if: always() && (needs.pre-release-validation.result == 'failure' || needs.goreleaser.result == 'failure' || needs.terraform-registry.result == 'failure')
    steps:
      - name: Notify on failure
        run: |
          echo "Release failed!"
          echo "Pre-release validation: ${{ needs.pre-release-validation.result }}"
          echo "GoReleaser: ${{ needs.goreleaser.result }}"
          echo "Terraform Registry: ${{ needs.terraform-registry.result }}"
          exit 1
          exit 1
